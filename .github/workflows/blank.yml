name: Build Full USB Modules Final
on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    container: 
      image: ghcr.io/openwrt/sdk:mediatek-filogic-24.10.4
      options: --user root  # 显式指定 root 运行
    
    env:
      HOME: /home/build     # 强制修改 HOME 指向
      FORCE_UNSAFE_CONFIGURE: 1 # 允许 root 编译

    steps:
      - name: Environment Fix
        run: |
          # 暴力解决所有可能的目录权限锁定
          chmod -R 777 . /home/build
          # 绕过 git 安全检查，直接修改环境变量而非 config 文件
          export GIT_CONFIG_PARAMETERS="'safe.directory=*'"
          
          # 初始化并更新，直接指向 SDK 根目录
          ./scripts/feeds update base
          ./scripts/feeds install kmod-usb-serial-option kmod-usb-net-qmi-wwan
          make defconfig

      - name: Prepare Kernel and Replace ID Table
        run: |
          # 1. 解压内核源码
          make target/linux/prepare V=s

          # 2. 定位内核目录
          KSRC=$(find build_dir -name "linux-6.6.110" -type d | head -n 1)
          echo "Found Kernel Source: $KSRC"

          # 3. 下载全量主线代码覆盖
          curl -sSL "https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/plain/drivers/usb/serial/option.c?h=v6.6.110" -o $KSRC/drivers/usb/serial/option.c
          curl -sSL "https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/plain/drivers/net/usb/qmi_wwan.c?h=v6.6.110" -o $KSRC/drivers/net/usb/qmi_wwan.c

      - name: Final Build
        run: |
          # 执行最终编译
          make package/kernel/linux/compile V=s

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: MT6000-Full-USB-Drivers
          path: bin/targets/mediatek/filogic/packages/kmod-*.ipk
